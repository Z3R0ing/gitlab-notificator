# GitLab Notificator

Spring Boot приложение, которое отправляет уведомления из GitLab в Telegram в реальном времени, помогая разработчикам, тимлидам и проджектам быть в курсе активности в проекте.

## Функциональность

- **Уведомления в реальном времени** для различных событий GitLab:
    - Создание, одобрение и слияние мердж-реквестов
    - Комментарии к мердж-реквестам
    - Создание новых задач (issues)
    - Создание тегов
    - Изменения статуса пайплайнов (успех/сбой)
    - Уведомления о деплое

- **Ролевые уведомления**:
    - Разработчики получают уведомления о назначенных им MR и ревью, а так же об успешном деплое
    - Тимлиды получают все важные уведомления проекта
    - ПМы получают уведомления о новых задачах и об успешном деплое

- **Интеграция с Telegram**:
    - Сообщения в формате Markdown с эмодзи
    - Встроенные кнопки для быстрого доступа к объектам GitLab
    - Настраиваемые параметры уведомлений

## Как это работает

1. Приложение получает события через вебхуки от GitLab
2. Обработчики событий обрабатывают различные типы событий (мердж-реквесты, задачи, пайплайны и т.д.)
3. Уведомления форматируются с соответствующей информацией и кнопками клавиатуры Telegram
4. Сообщения отправляются соответствующим пользователям Telegram на основе их роли и соответствия с пользователями GitLab

## Установка и настройка

### Предварительные требования

- Java 17 или выше
- Токен Telegram бота (от [@BotFather](https://t.me/BotFather))
- Экземпляр GitLab с правами на настройку вебхуков
- (Опционально) База данных PostgreSQL для production

### Конфигурация

1. Клонируйте репозиторий
2. Настройте переменные окружения:

```bash
# Конфигурация Telegram
export TG_BOT_TOKEN=your_telegram_bot_token
export TG_BOT_USERNAME=your_bot_username

# Конфигурация GitLab
export GITLAB_WEBHOOK_SECRET=your_webhook_secret
```

3. Настройте базу данных (выберите один вариант):

**Для разработки (H2 database):**
- Используется встроенная база данных H2 (дополнительная настройка не требуется)
- Доступ к консоли через `/h2-console`

**Для production (PostgreSQL):**
- Настройте переменные окружения

```bash
export SPRING_PROFILES_ACTIVE=postgre
# Конфигурация Postgres
export SPRING_DATASOURCE_URL=your_postgre_jdbc_url
export SPRING_DATASOURCE_USERNAME=your_postgre_username
export SPRING_DATASOURCE_PASSWORD=your_postgre_password
```

### Запуск приложения

**С использованием Docker:**
```bash
docker build -t gitlab-notificator .
docker run -p 8080:8080 \
  -e TG_BOT_TOKEN=your_token \
  -e GITLAB_WEBHOOK_SECRET=your_secret \
  gitlab-notificator
```

Добавьте переменные окружения для конфигурации Postgres при необходимости

**С использованием Gradle:**
```bash
./gradlew bootRun
```

**В виде JAR-файла:**
```bash
./gradlew bootJar
java -jar build/libs/*SNAPSHOT.jar
```

### Настройка вебхука в GitLab

В настройках вашего проекта GitLab:

1. Перейдите в раздел Webhooks
2. Установите URL: `https://your-domain.com/webhook/gitlab`
3. Установите Secret Token: должен совпадать с вашим `GITLAB_WEBHOOK_SECRET`
4. Выберите события для получения:
    - Merge Request events
    - Note events (comments)
    - Issue events
    - Tag push events
    - Pipeline events

### Соответствие пользователей

Настройте соответствие пользователей GitLab и Telegram ID в базе данных:

1. Приложение использует H2/PostgreSQL для хранения соответствий пользователей
2. Пользователи должны быть вручную добавлены в таблицу `user_mapping`
3. Каждое соответствие связывает GitLab user ID с Telegram chat ID

## Структура проекта

- `handler/` - Обработчики событий для различных типов событий GitLab
- `model/` - DTO и классы сущностей
- `service/` - Бизнес-логика и интеграция с Telegram
- `controller/` - Контроллер endpoint'а вебхука
- `util/` - Вспомогательные классы для форматирования сообщений

## Поддерживаемые события

- Мердж-реквесты: создание, одобрение, слияние, уход из черновика, назначение ревьюера
- Комментарии к мердж-реквестам
- Создание новых задач
- Создание новых тегов
- Изменения статуса пайплайнов (успех/сбой)
- Уведомления о деплое
```